ml_switcheroo.core.rewriter
===========================

.. py:module:: ml_switcheroo.core.rewriter

.. autoapi-nested-parse::

   Rewriter Package.

   This package provides the `PivotRewriter` class, composed of several mixins
   to handle specific aspects of the AST transformation:
   - Structure: Class and Function definitions.
   - Calls: Function invocations.
   - Attributes: Attribute access.
   - Normalization: Argument mapping.
   - ControlFlow: Loop and branching logic.
   - Decorators: Decorator handling.



Submodules
----------

.. toctree::
   :maxdepth: 1

   /api/ml_switcheroo/core/rewriter/attributes/index
   /api/ml_switcheroo/core/rewriter/base/index
   /api/ml_switcheroo/core/rewriter/calls/index
   /api/ml_switcheroo/core/rewriter/control_flow/index
   /api/ml_switcheroo/core/rewriter/decorators/index
   /api/ml_switcheroo/core/rewriter/normalization/index
   /api/ml_switcheroo/core/rewriter/structure/index
   /api/ml_switcheroo/core/rewriter/structure_class/index
   /api/ml_switcheroo/core/rewriter/structure_func/index
   /api/ml_switcheroo/core/rewriter/structure_types/index
   /api/ml_switcheroo/core/rewriter/types/index


Classes
-------

.. autoapisummary::

   ml_switcheroo.core.rewriter.CallMixin
   ml_switcheroo.core.rewriter.NormalizationMixin
   ml_switcheroo.core.rewriter.AttributeMixin
   ml_switcheroo.core.rewriter.StructureMixin
   ml_switcheroo.core.rewriter.DecoratorMixin
   ml_switcheroo.core.rewriter.ControlFlowMixin
   ml_switcheroo.core.rewriter.BaseRewriter
   ml_switcheroo.core.rewriter.PivotRewriter


Package Contents
----------------

.. py:class:: CallMixin(semantics: ml_switcheroo.semantics.manager.SemanticsManager, config: ml_switcheroo.config.RuntimeConfig)

   Bases: :py:obj:`ml_switcheroo.core.rewriter.normalization.NormalizationMixin`, :py:obj:`ml_switcheroo.core.rewriter.base.BaseRewriter`


   Mixin for transforming Call nodes and unpacking Assignments.


   .. py:method:: leave_Assign(original_node: libcst.Assign, updated_node: libcst.Assign) -> libcst.Assign

      Handles assignment unwrapping for Functional -> OOP transitions.

      Scenario: `y, updates = layer.apply(vars, x)`
      Target:   `y = layer(x)` (NNX/Torch style)



   .. py:method:: leave_Call(original: libcst.Call, updated: libcst.Call) -> Union[libcst.Call, libcst.BinaryOperation, libcst.UnaryOperation, libcst.CSTNode]

      Rewrites function calls with detailed Trace Logging.



.. py:class:: NormalizationMixin(semantics: ml_switcheroo.semantics.manager.SemanticsManager, config: ml_switcheroo.config.RuntimeConfig)

   Bases: :py:obj:`ml_switcheroo.core.rewriter.base.BaseRewriter`


   Mixin class providing argument normalization and operator transformation logic.

   Designed to be mixed into `PivotRewriter`. It relies on `self.semantics` to
   retrieve the argument specifications (`std_args`) and mapping rules.


.. py:class:: AttributeMixin(semantics: ml_switcheroo.semantics.manager.SemanticsManager, config: ml_switcheroo.config.RuntimeConfig)

   Bases: :py:obj:`ml_switcheroo.core.rewriter.base.BaseRewriter`


   Mixin for transforming attributes and tracking assignments.


   .. py:method:: leave_Assign(original_node: libcst.Assign, updated_node: libcst.Assign) -> libcst.Assign

      Track stateful assignments (e.g. self.layer = Linear(...)) to determine
      if an object variable requires special handling later.



   .. py:method:: leave_Attribute(original: libcst.Attribute, updated: libcst.Attribute) -> libcst.BaseExpression

      Visits attributes (e.g. torch.float32).



.. py:class:: StructureMixin(semantics: ml_switcheroo.semantics.manager.SemanticsManager, config: ml_switcheroo.config.RuntimeConfig)

   Bases: :py:obj:`ml_switcheroo.core.rewriter.structure_class.ClassStructureMixin`, :py:obj:`ml_switcheroo.core.rewriter.structure_func.FuncStructureMixin`, :py:obj:`ml_switcheroo.core.rewriter.structure_types.TypeStructureMixin`


   Composite mixin for all structural rewriting tasks.
   Inherits from granular mixins to assemble the full feature set.


.. py:class:: DecoratorMixin(semantics: ml_switcheroo.semantics.manager.SemanticsManager, config: ml_switcheroo.config.RuntimeConfig)

   Bases: :py:obj:`ml_switcheroo.core.rewriter.base.BaseRewriter`


   Mixin for transforming Decorator nodes.


   .. py:method:: leave_Decorator(original_node: libcst.Decorator, updated_node: libcst.Decorator) -> Union[libcst.Decorator, libcst.RemovalSentinel]

      Processes decorators attached to functions or classes.

      Logic:
      1. Identifies the decorator name (handling both `@name` and `@call(...)`).
      2. Looks up the semantic definition.
      3. If the target variant is explicitly `null` (None), removes the decorator.
      4. If the target variant specifies a new API, rewrites the name.



.. py:class:: ControlFlowMixin(semantics: ml_switcheroo.semantics.manager.SemanticsManager, config: ml_switcheroo.config.RuntimeConfig)

   Bases: :py:obj:`ml_switcheroo.core.rewriter.base.BaseRewriter`


   Mixin for visiting Control Flow nodes (For, While, If).


   .. py:method:: leave_For(original_node: libcst.For, updated_node: libcst.For) -> Union[libcst.For, libcst.CSTNode]

      Invokes the 'transform_for_loop' hook if registered.

      If no plugin is registered or the plugin returns the node unmodified,
      the loop preserves its Python semantics (appropriate for Torch/NumPy).
      If JAX/TF is the target, a plugin is expected to intercept this.



.. py:class:: BaseRewriter(semantics: ml_switcheroo.semantics.manager.SemanticsManager, config: ml_switcheroo.config.RuntimeConfig)

   Bases: :py:obj:`libcst.CSTTransformer`


   The base class for AST transformation traversal.

   .. attribute:: semantics

      The loaded knowledge base of API mappings.

      :type: SemanticsManager

   .. attribute:: config

      Configuration for the current run.

      :type: RuntimeConfig

   .. attribute:: source_fw

      The string identifier of the source framework (e.g., 'torch').

      :type: str

   .. attribute:: target_fw

      The string identifier of the target framework (e.g., 'jax').

      :type: str

   .. attribute:: strict_mode

      If True, unknown APIs trigger failure markers instead of pass-through.

      :type: bool

   .. attribute:: ctx

      The context object passed to plugins.

      :type: HookContext

   .. attribute:: _scope_stack

      A stack of scopes, tracking variables identified
      as stateful (e.g., neural network layers assigned to `self`).

      :type: List[Set[str]]

   .. attribute:: _signature_stack

      Stack tracking function signature details
      to support argument injection (like `rng`).

      :type: List[SignatureContext]

   .. attribute:: _alias_map

      Map of local names to fully qualified paths
      (e.g., `{'nn': 'torch.nn', 'F': 'torch.nn.functional'}`).

      :type: Dict[str, str]

   .. attribute:: _module_preamble

      Code statements to inject at the top of the file (module level).

      :type: List[str]


   .. py:attribute:: semantics


   .. py:attribute:: config


   .. py:attribute:: source_fw
      :value: ''



   .. py:attribute:: target_fw
      :value: ''



   .. py:attribute:: strict_mode


   .. py:attribute:: ctx


   .. py:method:: leave_Module(original_node: libcst.Module, updated_node: libcst.Module) -> libcst.Module

      Injects module-level preambles (e.g. Shim classes) requested by plugins.



   .. py:method:: visit_Import(node: libcst.Import) -> Optional[bool]

      Scans `import ...` statements to populate the alias map.
      Example: `import torch.nn as nn` -> `_alias_map['nn'] = 'torch.nn'`.



   .. py:method:: visit_ImportFrom(node: libcst.ImportFrom) -> Optional[bool]

      Scans `from ... import ...` statements to populate the alias map.
      Example: `from torch import nn` -> `_alias_map['nn'] = 'torch.nn'`.



   .. py:method:: visit_SimpleStatementLine(node: libcst.SimpleStatementLine) -> Optional[bool]

      Resets error tracking at the start of each line.
      Errors bubble up from children (Expressions) to this Statement handler.



   .. py:method:: leave_SimpleStatementLine(original_node: libcst.SimpleStatementLine, updated_node: libcst.SimpleStatementLine) -> Union[libcst.SimpleStatementLine, libcst.FlattenSentinel]

      If errors occurred during processing of this line's children (e.g. failing
      to rewrite a function call), wrap the line in an `EscapeHatch`.

      Prioritizes errors (reverting to original code) over warnings (using updated code).



.. py:class:: PivotRewriter(semantics: ml_switcheroo.semantics.manager.SemanticsManager, config: ml_switcheroo.config.RuntimeConfig)

   Bases: :py:obj:`control_flow.ControlFlowMixin`, :py:obj:`decorators.DecoratorMixin`, :py:obj:`calls.CallMixin`, :py:obj:`normalization.NormalizationMixin`, :py:obj:`attributes.AttributeMixin`, :py:obj:`structure.StructureMixin`, :py:obj:`base.BaseRewriter`


   The main AST transformer for ml-switcheroo.

   Inherits functionality from component identifiers (Mixins) and the base
   transformer logic. This class is the entry point for the ASTEngine.


