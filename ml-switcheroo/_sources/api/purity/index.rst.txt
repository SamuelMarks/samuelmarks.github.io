purity
======

.. py:module:: purity

.. autoapi-nested-parse::

   Static Purity Analysis for JAX Compliance.

   This module provides the `PurityScanner`, a LibCST transformer that detects
   operations unsafe for functional frameworks (like JAX). JAX transformation
   (JIT, VMap, Grad) requires pure functions with no side effects.

   Operations flagged:
   1.  **I/O**: `print`, `input`, `open`, `write`.
   2.  **Global State**: `global` keyword usage.
   3.  **Closure State**: `nonlocal` keyword usage (Feature 05).
   4.  **Structure Mutation**: List methods `append`, `extend`, `pop`, etc.
   5.  **Global RNG**: Seeding operations like `random.seed`, `torch.manual_seed`.

   Violations are marked via the `EscapeHatch` mechanism, wrapping the code
   with warning comments without altering the logic.



Classes
-------

.. autoapisummary::

   purity.PurityScanner


Module Contents
---------------

.. py:class:: PurityScanner

   Bases: :py:obj:`libcst.CSTTransformer`


   Scans CST for impurities and wraps violations in EscapeHatch markers.

   This transformer operates at the statement level. If a statement contains
   unsafe expressions (like `print()` or `list.append()`), the entire statement
   is wrapped in failure markers with a specific reason.

   .. attribute:: _current_violations

      Accumulator of errors for the current statement.

      :type: List[str]

   .. attribute:: _IO_FUNCTIONS

      Set of function names considered I/O side effects.

      :type: Set[str]

   .. attribute:: _MUTATION_METHODS

      Set of method names considered in-place mutation.

      :type: Set[str]

   .. attribute:: _GLOBAL_RNG_METHODS

      Set of method names that mutate global random state.

      :type: Set[str]


   .. py:method:: visit_SimpleStatementLine(node: libcst.SimpleStatementLine) -> Optional[bool]

      Enters a statement line. Resets violation tracking.

      :param node: The statement line node being visited.

      :returns: True to verify children.



   .. py:method:: leave_SimpleStatementLine(original_node: libcst.SimpleStatementLine, updated_node: libcst.SimpleStatementLine) -> Union[libcst.SimpleStatementLine, libcst.FlattenSentinel]

      Exits a statement line.
      If violations were found within this statement, wraps it in the EscapeHatch.

      :param original_node: The node before transformations.
      :param updated_node: The node after internal transformations.

      :returns: The original/updated node, potentially wrapped in an EscapeHatch if impure.



   .. py:method:: visit_Global(node: libcst.Global) -> Optional[bool]

      Detects `global` keyword usage.

      Global variables break functional purity assumptions.

      :param node: The Global statement node.

      :returns: False to stop traversing children.



   .. py:method:: visit_Nonlocal(node: libcst.Nonlocal) -> Optional[bool]

      Detects `nonlocal` keyword usage.

      Modifying closure variables (nonlocal state) breaks JAX JIT tracers which
      assume stateless functions or explicit argument passing.

      :param node: The Nonlocal statement node.

      :returns: False to stop traversing children.



   .. py:method:: visit_Call(node: libcst.Call) -> Optional[bool]

      Inspects calls for I/O functions, list mutations, or global RNG seeding.

      :param node: The Call node.

      :returns: True to traverse arguments.



