ml_switcheroo.plugins.loop_unroll
=================================

.. py:module:: ml_switcheroo.plugins.loop_unroll

.. autoapi-nested-parse::

   Plugin for Unrolling Loops (Functional Control Flow Enforcement).

   This module handles the structural transformation of Python control flow into
   functional primitives required by XLA-based frameworks. Unlike PyTorch/TensorFlow Eager,
   which support imperative Python loops, frameworks targeting XLA (like JAX) require
   loops to be expressed as functional operators (`scan` or `fori_loop`) to be compiled.

   The strategy is **Safety-First**:

   1.  **Analysis**: Inspects `for` loops.
   2.  **Trait Check**: Determines if the target framework requires functional control flow.
   3.  **Handling**: Wraps imperative loops in an `EscapeHatch` warning rather than
       attempting unsafe auto-conversion (solving the "carry state" problem is often undecidable).



Functions
---------

.. autoapisummary::

   ml_switcheroo.plugins.loop_unroll.transform_loops


Module Contents
---------------

.. py:function:: transform_loops(node: libcst.For, ctx: ml_switcheroo.core.hooks.HookContext) -> Union[libcst.For, libcst.FlattenSentinel]

   Plugin Hook: Transforms or Flags `for` loops for functional compliance.

   Triggered by the `ControlFlowMixin` when visiting `For` nodes.

   Strategy:

   - Check `ctx.plugin_traits.requires_functional_control_flow`.
   - If False: Pass through (Imperative loops are valid).
   - If True:
       - Analyze the iterator.
       - If `range()`: Warn that `jax.lax.fori_loop` (or equivalent) is required.
       - Else: Warn that `scan` is required.
       - Wrap in `EscapeHatch` to prevent compilation errors in the target.

   :param node: The original CST For loop node.
   :param ctx: Hook context containing framework configuration traits.

   :returns: The transformed node or an EscapeHatch sentinel.


