ml_switcheroo.core.mlir.generator
=================================

.. py:module:: ml_switcheroo.core.mlir.generator

.. autoapi-nested-parse::

   MLIR to Python (LibCST) Generator.

   This module provides the `MlirToPythonGenerator` class, which consumes the
   MLIR CST object model and reconstructs valid Python code via LibCST.

   It performs the inverse operation of the Emitter:
   1.  **Dialect Interpretation**: Maps `sw.*` ops back to Python constructs.
   2.  **SSA Resolution**: Converts `%id` references into readable Python variable names.
   3.  **Trivia Restoration**: Transforms `// comment` back to `# comment`.
   4.  **Expression Folding**: Inlines single-use intermediates (SSA values) to
       produce Pythonic code (e.g. `f(x)` instead of `_1=x; _2=f(_1);`).

   Feature Hardening:
   - Robustly handles `sw.op` "type" attributes for deep class hierarchies (e.g. `torch.nn.Conv2d`).
   - Distinguishes between static operation calls (`sw.op`) and dynamic calls (`sw.call`).
   - Ensures valid assignment generation for results.
   - **Naming Heuristics**: Preserves variable names based on SSA IDs or Type Hints, prioritizing stability.
   - **Type Reconstruction**: Restores Python type hints from MLIR `!sw.type` annotations.



Classes
-------

.. autoapisummary::

   ml_switcheroo.core.mlir.generator.NamingContext
   ml_switcheroo.core.mlir.generator.MlirToPythonGenerator


Module Contents
---------------

.. py:class:: NamingContext

   Tracks mapping between MLIR SSA IDs and Python variable names.
   Ensures generated names are valid identifiers.


   .. py:method:: register(ssa_name: str, hint: Optional[str] = None) -> str

      Assigns a valid Python name to an SSA value.

      Naming Strategy:
      1. If hint provided: Use hint (cleaned).
      2. If SSA ID (e.g. %res): Use prefix + ID body (e.g. _res).
      3. Heuristic: Strip trailing numeric counters from SSA hints if base is unique.
         (e.g., %self0 -> self, %x5 -> x).

      :param ssa_name: The MLIR variable name (e.g. "%0", "%arg0").
      :param hint: Optional string to guide naming (e.g. "x" from original source).

      :returns: The resolved Python identifier string.



   .. py:method:: lookup(ssa_name: str) -> str

      Retrieves Python name for SSA ID.

      :param ssa_name: The MLIR variable name.

      :returns: The mapped Python name, or safe fallback if not registered.



.. py:class:: MlirToPythonGenerator

   Transpiler back-end: MLIR CST -> Python LibCST.


   .. py:attribute:: ctx


   .. py:attribute:: usage_counts
      :type:  Dict[str, int]


   .. py:attribute:: deferred_exprs
      :type:  Dict[str, libcst.BaseExpression]


   .. py:method:: generate(node: ml_switcheroo.core.mlir.nodes.ModuleNode) -> libcst.Module

      Main entry point. Converts MLIR Module to Python Module.

      :param node: The root MLIR ModuleNode.

      :returns: A LibCST Module object representing the Python code.



