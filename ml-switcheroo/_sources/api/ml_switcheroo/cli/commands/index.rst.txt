ml_switcheroo.cli.commands
==========================

.. py:module:: ml_switcheroo.cli.commands

.. autoapi-nested-parse::

   CLI Command Handlers Facade.

   This module primarily re-exports handlers from `ml_switcheroo.cli.handlers`
   to maintain backward compatibility with existing tests and imports.



Classes
-------

.. autoapisummary::

   ml_switcheroo.cli.commands.SemanticsManager
   ml_switcheroo.cli.commands.FrameworkSyncer
   ml_switcheroo.cli.commands.SemanticPersister
   ml_switcheroo.cli.commands.ConsensusEngine
   ml_switcheroo.cli.commands.BatchValidator
   ml_switcheroo.cli.commands.ReadmeEditor


Functions
---------

.. autoapisummary::

   ml_switcheroo.cli.commands.handle_audit
   ml_switcheroo.cli.commands.handle_convert
   ml_switcheroo.cli.commands.handle_scaffold
   ml_switcheroo.cli.commands.handle_import_spec
   ml_switcheroo.cli.commands.handle_sync_standards
   ml_switcheroo.cli.commands.handle_snapshot
   ml_switcheroo.cli.commands.handle_sync
   ml_switcheroo.cli.commands.handle_wizard
   ml_switcheroo.cli.commands.handle_harvest
   ml_switcheroo.cli.commands.handle_ci
   ml_switcheroo.cli.commands.handle_matrix
   ml_switcheroo.cli.commands.handle_docs
   ml_switcheroo.cli.commands.handle_gen_tests
   ml_switcheroo.cli.commands.available_frameworks
   ml_switcheroo.cli.commands.get_adapter
   ml_switcheroo.cli.commands.resolve_semantics_dir
   ml_switcheroo.cli.commands.resolve_snapshots_dir


Module Contents
---------------

.. py:function:: handle_audit(path: pathlib.Path, source_frameworks: List[str]) -> int

   Scans a directory/file to determine coverage against the Knowledge Base.

   :param path: Input source.
   :param source_frameworks: List of framework keys to scan for.


.. py:function:: handle_convert(input_path: pathlib.Path, output_path: Optional[pathlib.Path], source: Optional[str], target: Optional[str], verify: bool, strict: Optional[bool], plugin_settings: Dict[str, Any], json_trace_path: Optional[pathlib.Path] = None) -> int

   Handles the 'convert' command execution.

   Orchestrates the loading of configuration, initialization of the semantic
   knowledge base, and the execution of the transpilation engine on files or directories.

   :param input_path: Path to the source file or directory to convert.
   :param output_path: Path where generated code should be saved.
   :param source: Override for source framework (e.g. 'torch').
   :param target: Override for target framework (e.g. 'jax').
   :param verify: If True, generates and runs a verification harness test immediately.
   :param strict: If True, enforces strict strict_mode on the Engine.
   :param plugin_settings: Dictionary of specific plugin configuration flags.
   :param json_trace_path: Optional path to dump execution trace JSON.

   :returns: Exit code (0 for success, 1 for failure).
   :rtype: int


.. py:function:: handle_scaffold(frameworks: list[str], out_dir: pathlib.Path) -> int

   Handles the 'scaffold' command.

   -   Iterates through provided frameworks.
   -   Uses `FrameworkAdapter.discovery_heuristics` regexes to fuzzy match framework
       APIs against known specs or structural conventions.
   -   Populates semantic specs (Hub) and framework mappings (Spokes/Snapshots).

   :param frameworks: List of framework package names to scaffold (e.g., ['torch', 'jax']).
   :type frameworks: list[str]
   :param out_dir: The root directory for generating the knowledge base.
                   Defaults to the package source if None.
   :type out_dir: Path

   :returns: Exit code.
   :rtype: int


.. py:function:: handle_import_spec(target: pathlib.Path) -> int

   Handles the 'import-spec' command.

   Parses upstream standards documentation or stubs and merges the definitions
   into the local semantics Hub.

   :param target: Code resource to import ('internal', .md file, or directory).
   :type target: Path

   :returns: Exit code.
   :rtype: int


.. py:function:: handle_sync_standards(categories: List[str], frameworks: Optional[List[str]], dry_run: bool) -> int

   Handles 'sync-standards' command.

   Invokes the Consensus Engine to automatically discover new Abstract Operations
   by finding commonalities across multiple framework API surfaces. Writes the
   results to `k_discovered.json` (The Unofficial/Discovered Standard).

   :param categories: List of category strings (layer, loss, etc.) to scan.
   :type categories: List[str]
   :param frameworks: List of framework keys to scan.
                      Defaults to installed/registered frameworks.
   :type frameworks: Optional[List[str]]
   :param dry_run: If True, prints results without saving.
   :type dry_run: bool

   :returns: Exit code.
   :rtype: int


.. py:function:: handle_snapshot(out_dir: Optional[pathlib.Path]) -> int

   Handles the 'snapshot' command.

   Scans installed frameworks and dumps their API signatures to JSON files.
   These snapshots allow the engine to operate in "Ghost Mode" (e.g., in WebAssembly)
   without requiring the heavy frameworks to be installed.

   :param out_dir: Optional custom output directory. Defaults to package/snapshots.

   :returns: Exit code.
   :rtype: int


.. py:function:: handle_sync(framework: str) -> int

   Handles the 'sync' command.

   Links the Abstract Standards (Hub) to the concrete implementation in a
   specific framework. This process involves:
   1.  Reading the Specs from `semantics/`.
   2.  Introspecting the installed framework to find matching APIs.
   3.  **Merging Static Definitions** from the Adapter (for Ghost support).
   4.  Applying Adapter-specific manual wiring (plugins, templates).
   5.  **Persisting Test Configuration templates**.
   6.  Writing the results to the Snapshot Overlay (`snapshots/{fw}_mappings.json`).

   :param framework: The framework key to sync (e.g. 'torch', 'jax').

   :returns: Exit code.
   :rtype: int


.. py:function:: handle_wizard(package: str) -> int

   Handles the 'wizard' command for interactive mapping discovery.

   :param package: The name of the python package to inspect (e.g., 'torch').

   :returns: Exit code (0 for success).
   :rtype: int


.. py:function:: handle_harvest(path: pathlib.Path, target: str, dry_run: bool) -> int

   Handles the 'harvest' command to learn mappings from manual tests.

   :param path: File or directory containing python test files.
   :param target: The framework target used in the tests (e.g., 'jax').
   :param dry_run: If True, prints changes without writing to disk.

   :returns: Exit code (0 for success, 1 for path errors).
   :rtype: int


.. py:function:: handle_ci(update_readme: bool, readme_path: pathlib.Path, json_report: Optional[pathlib.Path]) -> int

   Handles 'ci' command.


.. py:function:: handle_matrix() -> int

   Handles 'matrix' command.


.. py:function:: handle_docs(source: str, target: str, out_path: pathlib.Path) -> int

   Handles 'gen-docs' command.


.. py:function:: handle_gen_tests(out: pathlib.Path) -> int

   Handles 'gen-tests' command.


.. py:class:: SemanticsManager

   Central database for semantic mappings and configuration.


   .. py:attribute:: data
      :type:  Dict[str, Dict]


   .. py:attribute:: import_data
      :type:  Dict[str, Dict]


   .. py:attribute:: framework_configs
      :type:  Dict[str, Dict]


   .. py:attribute:: test_templates
      :type:  Dict[str, Dict]


   .. py:method:: get_all_rng_methods() -> Set[str]


   .. py:method:: resolve_variant(abstract_id: str, target_fw: str) -> Optional[Dict[str, Any]]


   .. py:method:: load_validation_report(report_path: pathlib.Path) -> None


   .. py:method:: is_verified(abstract_id: str) -> bool


   .. py:method:: get_definition_by_id(abstract_id: str) -> Optional[Dict[str, Any]]


   .. py:method:: get_definition(api_name: str) -> Optional[Tuple[str, Dict]]


   .. py:method:: get_known_apis() -> Dict[str, Dict]


   .. py:method:: get_import_map(target_fw: str) -> Dict[str, Tuple[str, Optional[str], Optional[str]]]


   .. py:method:: get_framework_config(framework: str) -> Dict[str, Any]


   .. py:method:: get_test_template(framework: str) -> Optional[Dict[str, str]]


   .. py:method:: get_framework_aliases() -> Dict[str, Tuple[str, str]]


   .. py:method:: update_definition(abstract_id: str, new_data: Dict[str, Any]) -> None


.. py:class:: FrameworkSyncer

   Links abstract operations to concrete framework implementations.

   .. attribute:: console

      A configured Rich console for logging output.


   .. py:attribute:: console


   .. py:method:: sync(tier_data: Dict[str, Any], framework: str) -> None

      Updates the 'variants' dict in tier_data by hunting for ops in the target framework.



.. py:function:: available_frameworks() -> List[str]

   Returns a list of all registered framework keys.


.. py:function:: get_adapter(name: str) -> Optional[FrameworkAdapter]

.. py:class:: SemanticPersister

   Handles serialization of Discovered Standards to disk using Hub-and-Spoke architecture.


   .. py:method:: persist(candidates: List[ml_switcheroo.discovery.consensus.CandidateStandard], target_spec_file: pathlib.Path) -> None

      Splits and persists candidates into Specifications (Hub) and Snapshots (Spokes).

      :param candidates: List of aligned CandidateStandard objects.
      :param target_spec_file: Path to the JSON semantic spec file (Hub) to update/create.
                               (e.g., `semantics/k_framework_extras.json`)



.. py:class:: ConsensusEngine

   Algorithms for aligning divergent API naming conventions.

   Capabilities:

   1.  **Clustering**: Groups APIs like `HuberLoss`, `huber_loss`, and `Huber` together.
   2.  **Normalization**: Strips common noise (prefixes/suffixes) to find the semantic root.
   3.  **Signature Alignment**: Builds a translation map for arguments (e.g., `keepdims` <-> `keep_dims`).


   .. py:attribute:: IGNORED_SUFFIXES
      :value: ['loss', 'error', 'layer', 'block', '2d', '1d', '3d', 'v1', 'v2', 'object', 'op', 'func']



   .. py:attribute:: ARG_ALIASES


   .. py:method:: normalize_name(name: str) -> str
      :classmethod:


      Reduces an API Name to its semantic core for comparison.

      This removes casing, underscores, and common prefixes/suffixes.

      .. rubric:: Examples

      * 'HuberLoss' -> 'huber'
      * 'reduce_mean' -> 'mean'
      * 'conv2d' -> 'conv'

      :param name: The raw API name (e.g. 'CrossEntropyLoss').
      :type name: str

      :returns: The normalized key (e.g. 'crossentropy').
      :rtype: str



   .. py:method:: normalize_arg(arg_name: str) -> str
      :classmethod:


      Canonicalizes an argument name using the alias map.

      .. rubric:: Example

      'learning_rate' -> 'lr'

      :param arg_name: The raw argument name.
      :type arg_name: str

      :returns: The canonical standard name.
      :rtype: str



   .. py:method:: cluster(framework_inputs: Dict[str, List[ml_switcheroo.core.ghost.GhostRef]]) -> List[CandidateStandard]

      Groups API definitions from multiple frameworks into Candidates based on name similarity.

      :param framework_inputs: Dictionary mapping 'framework_name' -> List of discovered GhostRefs.

      :returns: A list of potential standards, sorted by descending score.
      :rtype: List[CandidateStandard]



   .. py:method:: filter_common(candidates: List[CandidateStandard], min_support: int = 2) -> List[CandidateStandard]

      Filters candidates to keep only those present in a minimum number of frameworks.

      This ensures we only create standards for concepts that are truly shared across
      ecosystems, avoiding framework-specific noise.

      :param candidates: List of candidates from clustering.
      :type candidates: List[CandidateStandard]
      :param min_support: Minimum number of different frameworks that must implement the op.
      :type min_support: int

      :returns: Filtered list of robust candidates.
      :rtype: List[CandidateStandard]



   .. py:method:: align_signatures(candidates: List[CandidateStandard], consensus_threshold: float = 0.5) -> None

      Analyses the arguments of all variants in a candidate to determine Standard Arguments.

      It populates `std_args` on the candidate by voting: if an argument (normalized)
      appears in >50% of the implementations, it becomes part of the standard signature.

      It also populates `arg_mappings` to translate between the Standard name and
      the specific framework name (e.g. Standard 'dim' -> Torch 'dim', Jax 'axis').

      :param candidates: List of CandidateStandards to process (in-place modification).
      :type candidates: List[CandidateStandard]
      :param consensus_threshold: Fraction of variants that must share an arg (0.0 - 1.0).
      :type consensus_threshold: float



.. py:class:: BatchValidator(semantics: ml_switcheroo.semantics.manager.SemanticsManager)

   Orchestrates the validation of the entire knowledge base.


   .. py:attribute:: semantics


   .. py:attribute:: runner


   .. py:method:: run_all(verbose: bool = False, manual_test_dir: Optional[pathlib.Path] = None) -> Dict[str, bool]

      Runs verification for all known APIs.

      Validation Hierarchy:

      1. **Manual Test Priority**: If a file contains `def test_<op_name>():`,
         we assume the developer has manually verified this operation. It is
         marked as Passing.
      2. **Automated Fuzzing**: If no manual test exists, we unpack the
         arguments and type hints from the spec, generate random inputs, and
         check equivalence using `EquivalenceRunner`.

      :param verbose: Show progress bar using Rich.
      :param manual_test_dir: Directory containing manual tests to scan (default: None).

      :returns: Validation status (True=Pass, False=Fail).
      :rtype: Dict[op_name, bool]



.. py:class:: ReadmeEditor(semantics: ml_switcheroo.semantics.manager.SemanticsManager, readme_path: pathlib.Path)

   Utility to programmatically update the README.md with verification results.

   It regenerates the "Compatibility Matrix" table based on the current state of
   the Knowledge Base and the results of the latest CI run, then splices it
   into the README content using regex markers.

   .. attribute:: semantics

      Source of Truth for API definitions.

      :type: SemanticsManager

   .. attribute:: readme_path

      Path to the README file.

      :type: Path


   .. py:attribute:: semantics


   .. py:attribute:: readme_path


   .. py:method:: update_matrix(validation_results: Dict[str, bool]) -> bool

      Regenerates the Markdown table and injects it into the README.

      It looks for the section starting with `## âœ… Compatibility Matrix` and
      replaces the content up to the next `## Header` or End of File.

      :param validation_results: Dictionary mapping op_name -> boolean pass status.

      :returns: True if the update was successful, False otherwise.
      :rtype: bool



.. py:function:: resolve_semantics_dir() -> pathlib.Path

   Locates the directory containing semantic JSON definitions.

   Prioritizes the local file system (relative to this file) to ensure
   tests and editable installs find the source of truth correctly.
   Falls back to package resources for installed distributions.

   :returns: The absolute path to the 'semantics' directory.
   :rtype: Path


.. py:function:: resolve_snapshots_dir() -> pathlib.Path

   Locates the directory containing framework snapshots and mapping overlays.
   Defaults to the sibling 'snapshots' directory relative to 'semantics'.

   :returns: The absolute path to the 'snapshots' directory.
   :rtype: Path


